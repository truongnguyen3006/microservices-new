# ============================
# 1. Tối ưu Worker
# ============================

worker_processes auto;                # Tự động spawn theo số CPU
worker_rlimit_nofile 65535;           # Giới hạn file mở tối đa
events {
    worker_connections 20000;         # Mỗi worker xử lý 20k kết nối
    multi_accept on;                  # Nhận nhiều connection đồng thời
    use epoll;                        # Epoll cho Linux (tối ưu nhất)
}


# ============================
# 3. HTTP Settings
# ============================

http {

    # Định nghĩa format log mới tên là 'upstream_time'
    log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent" '
                             'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time" '
                             'upstream_addr="$upstream_addr" upstream_status="$upstream_status"';

    # Áp dụng format này cho access log
    access_log /var/log/nginx/access.log upstream_time;

    include mime.types;
    default_type application/octet-stream;

    # ---- TCP / Network ----
    sendfile on;                      # Tăng tốc gửi file
    tcp_nopush on;                    # Gửi gói to tối ưu
    tcp_nodelay on;                   # Giảm độ trễ

    # ---- Timeout ----
    #keepalive_timeout 65;
    #client_header_timeout 10s;
    #client_body_timeout 10s;
    #send_timeout 10s;

    keepalive_timeout 300;       # Giữ kết nối lâu hơn
    client_header_timeout 300s;
    client_body_timeout 300s;
    send_timeout 300s;

    # ---- Buffer ----
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      "";
    }
    upstream backend_gateways {
        least_conn;                   # Server ít kết nối nhất nhận request

        server host.docker.internal:8080 max_fails=0;
        server host.docker.internal:8090 max_fails=0;

        keepalive 64;                 # Giữ 64 TCP connection
    }
    server {

        listen 80 backlog=10240;      # Hàng đợi connection

        location / {

            proxy_pass http://backend_gateways;

            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;



            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 3; # Thử tối đa 3 lần

            # ---- Headers cho Microservices ----
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # ---- WebSocket ----
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # ---- Buffer Proxy ----
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;

            # ---- Debug Header ----
            add_header X-Server-IP $upstream_addr always;
        }
    }
}
