# cung cap dia chi cua may chu Eureka (Discovery Server) de no co the tu dang ky
eureka.client.serviceUrl.defaultZone=http://eureka:password@localhost:8761/eureka
spring.application.name=api-gateway

logging.level.org.springframework.cloud.gateway.route.RouteDefinitionLocator = INFO
logging.level.org.springframework.cloud.gateway = TRACE

# === GIẢI THÍCH VỀ "lb://" (Load Balancing) ===
#
# Cấu hình `uri=lb://product-service` KHÔNG phải là cân bằng tải của Kafka (Lý thuyết 2).
# Đây là cân bằng tải phía Client (Client-Side Load Balancing) được cung cấp bởi
# Spring Cloud Gateway và Eureka (Service Discovery).
#
# Nó có nghĩa là: "Khi có request tới /api/product/**, hãy tìm một instance
# của service tên là 'product-service' đã đăng ký trên Eureka và chuyển request đến đó."
#
# Điều này giúp mở rộng tầng API Gateway, không liên quan trực tiếp đến
# cách các service bên trong giao tiếp qua Kafka.
#

## Product Service Route
spring.cloud.gateway.server.webflux.routes[0].id=product-service
# dung goi yeu cau den mot dia chi IP va cong co dinh. Thay vao do,
# hay su dung co che can bang tai (Load Balancing) phia client
# ten dang ky cua dich vu dich tren Eureka
spring.cloud.gateway.server.webflux.routes[0].uri=lb://product-service
spring.cloud.gateway.server.webflux.routes[0].predicates[0]=Path=/api/product/**

## Order Service Route
spring.cloud.gateway.server.webflux.routes[1].id=order-service
spring.cloud.gateway.server.webflux.routes[1].uri=lb://order-service
spring.cloud.gateway.server.webflux.routes[1].predicates[0] = Path=/api/order/**

## Discover Server Route
# xu ly yeu cau ban dau de lay trang HTML chinh
# va sua doi duong dan cho dung
spring.cloud.gateway.server.webflux.routes[2].id=discovery-server
spring.cloud.gateway.server.webflux.routes[2].uri=http://localhost:8761
spring.cloud.gateway.server.webflux.routes[2].predicates[0]=Path=/eureka/web
# Gateway Filter cho phep ban sua doi yeu cau (request) HTTP truoc khi no duoc chuyen den dich vu dich
spring.cloud.gateway.server.webflux.routes[2].filters[0]=SetPath=/

## User Service Route
spring.cloud.gateway.server.webflux.routes[3].id=user-service
spring.cloud.gateway.server.webflux.routes[3].uri=lb://user-service
spring.cloud.gateway.server.webflux.routes[3].predicates[0] =Path=/api/user/**, /auth/**, /api/admin/**


## Discover Server Route Static Resources Route
# mot route "bat tat ca" de dam bao tat ca cac tai nguyen phu (CSS, JS, vv)
# ma trang HTML do yeu cau cung duoc dinh tuyen chinh xac den Eureka Server
spring.cloud.gateway.server.webflux.routes[4].id=discovery-server-static
spring.cloud.gateway.server.webflux.routes[4].uri=http://localhost:8761
spring.cloud.gateway.server.webflux.routes[4].predicates[0] = Path=/eureka/**

spring.cloud.gateway.server.webflux.routes[5].id=payment-service
spring.cloud.gateway.server.webflux.routes[5].uri=lb://payment-service
spring.cloud.gateway.server.webflux.routes[5].predicates[0] = Path=/api/payment/**

spring.cloud.gateway.server.webflux.routes[6].id=inventory-service
spring.cloud.gateway.server.webflux.routes[6].uri=lb://inventory-service
spring.cloud.gateway.server.webflux.routes[6].predicates[0] = Path=/api/inventory/**

# === CẤU HÌNH TRACING (MICROMETER & ZIPKIN) ===
# ===============================================

# 1. Bật tính năng gửi trace đến Zipkin
spring.zipkin.enabled=true
# 2. Chỉ định địa chỉ của Zipkin server (chúng ta sẽ chạy ở Docker)
spring.zipkin.base-url=http://localhost:9411/

# 3. Cấu hình "Sampler" (Bộ lấy mẫu)
# Để test, chúng ta muốn "ghi lại" TẤT CẢ 100% các request
# (Khi lên production, bạn nên giảm xuống 0.1, tức 10%)
management.tracing.sampling.probability=1.0

spring.security.oauth2.resourceserver.jwt.issuer-uri=http://keycloak:8085/realms/spring-boot-microservices-realm

logging.level.org.springframework.cloud.loadbalancer=DEBUG
logging.level.reactor.netty.http.client=DEBUG

# 1. (QUAN TRỌNG NHẤT) TẮT cache của Spring Cloud Load Balancer.
# Điều này buộc gateway phải lấy danh sách service mới
# thay vì dùng danh sách cũ chỉ có 1 instance.
spring.cloud.loadbalancer.cache.enabled=false

# 2. (Khuyến nghị) Buộc gateway làm mới danh sách từ Eureka
# 5 giây một lần (mặc định là 30 giây)
eureka.client.registry-fetch-interval-seconds=5

# Tăng số lượng thread xử lý request tối đa (mặc định 200)
server.tomcat.threads.max=500

# Tăng hàng chờ request (mặc định 100)
server.tomcat.accept-count=200
